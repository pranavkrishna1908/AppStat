---
title: "Final Report"
output: html_document
date: "2023-05-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

In this project, we look at the spread of COVID-19 in the United States in the first wave. We explore the Data using PCA and report our exploratory findings. We recall that the response to the pandemic was fragmented, even in the initial stages of the pandemic, wherein all states had slightly different degrees of stay at home, face covering and travel restrictions which were implemented at different points of time. Thus, we restrict ourselves to exploratory data analysis on this data-set.

The data we have is regarding the cumulative number of deaths cases in USA by county. We decided to group it by state and  to threshold at 2 Deaths in each state to declare the start of the pandemic. Then, we look at the next 60 days and study the evolution of the pandemic dynamics. 

However, we recognise that an increase of 5 deaths at the beginning of the wave may not have the same relative impact as 5 deaths towards the end of the wave. To ensure a more comparable scale for the data, we apply a logarithmic transformation to these cumulative numbers. We apply hte PCA on this data to gather insights about the progression of the pandemic.

```{r cars, include = FALSE}
library(tidyverse)
library(readr)

covid_deaths_usafacts <- read_csv("covid_deaths_usafacts.csv")
data = covid_deaths_usafacts[, !colnames(covid_deaths_usafacts) %in% c("countyFIPS", "County Name", "StateFIPS")]
statewise_data = data %>%   group_by(State) %>% 
  summarize_all(sum)
data_daily = t ( statewise_data[,-1])
colnames(data_daily) = as.vector(statewise_data$State)
populations = c(733583, 5074296, 3045637, 7359197, 39029342, 5839926, 3626205,
                671803, 1018396, 22244823, 10912876, 1440196, 3200517, 1939033,
                12582032, 6833037, 2937150, 4512310, 4590241, 6981974, 6164660, 
                1385340, 1385340, 5717184, 6177957, 2940057, 1122867, 
                10698973, 779261, 1967923, 1395231, 9261699, 2113344, 3177772 ,19677151, 
                11756058, 4019800, 4240137, 12972008, 1093734, 5282634, 909824, 
                7051339, 30029572, 3380800, 8683619, 647064, 7785786, 5892539,
                1775156, 581381)
######
deaths_threshold = 2
count_data_fewdays = apply(data_daily, 2,
                           function(coloumn)
                          coloumn[which(coloumn>deaths_threshold)[1]:(which(coloumn>deaths_threshold)[1] + 60)] )
percapita = apply(count_data_fewdays , 1, function(row) row/populations)
final = apply(percapita,1, function(row) predict(smooth.spline(row))$y )

logged_cmulative = apply(final, 2, function(row) log(row, base =2))
data_prepared = t(logged_cmulative)#states should be rows
PCA_data = scale(data_prepared, center = TRUE, scale = FALSE)
# results = svd(PCA_data)
# plot(abs(results$v[,1]))
# plot(abs(results$v[,2]))
# plot(results$v[,3])
# total_d_i = sum(results$d**2)
# var_explained = 100*results$d**2/total_d_i
# print(var_explained[1])
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
xeval <- 1:61
perform_pca <- function(X){
  mu <- colMeans(X)
  X <- sweep(X,2,mu)
  
  SVD <- svd(X)
  Scores <- SVD$u %*% diag(SVD$d)
  Loadings <- SVD$v
  # cat(cumsum(SVD$d^2/sum(SVD$d^2))[1:5]) # FVE
  FVE <- SVD$d^2/sum(SVD$d^2)
  # plot(SVD$d^2/sum(SVD$d^2), type="h")
  
  lam <- sqrt(length(xeval)) # measure change
  #op <- par(mfrow=c(3,2),mar=rep(2,4))
  plot(xeval, X[1,]+mu,type="l", ylim=range(X+mu), main=" Figure 1: Data and the mean")
  for(n in 1:dim(X)[1]) points(xeval, X[n,]+mu,type="l")
  points(xeval,mu,col=2,lwd=2,type="l")
  
# Set up the color palette

# Assign colors based on democratic support values
democratic_support <- c(40, 35, 42, 48, 62, 52, 48, 90, 70, 50, 47, 60, 44, 38, 55, 42, 40, 38, 46, 55, 50, 45, 48, 51, 42, 43, 39, 45, 57, 65, 54, 49, 60, 58, 45, 52, 55, 58, 42, 46, 65, 52, 49, 56, 53, 44, 57, 61, 55, 52, 59, 48, 44, 51, 43)

# Plotting
#plot(Scores[1,]*sign(sum(Loadings[,1])), Scores[2,]*sign(sum(Loadings[,2])), main="Figure 2: 1st vs 2nd PC scores", xlim = c(-1,1), col = colors)

ggplot()+
  geom_point(aes(Scores[1,]*sign(sum(Loadings[,1])), Scores[2,]*sign(sum(Loadings[,2])),alpha  = democratic_support),  colour = 'Green')
  
  plot(xeval,Loadings[,1]*sign(sum(Loadings[,1])),type="l", main=paste0("1st PC (",round(100*FVE[1])," % of var)"))
  # plot(xeval, X[1,]+mu,type="l", ylim=range(X+mu))
  # for(n in 1:dim(X)[1]) points(xeval, X[n,]+mu,type="l")
  # points(xeval,mu,col=2,lwd=2,type="l")
  # points(xeval,mu+3*SVD$d[1]/lam*SVD$v[,1],col=2,lwd=2,type="l",lty=2)
  # points(xeval,mu-3*SVD$d[1]/lam*SVD$v[,1],col=2,lwd=2,type="l",lty=2)
  
  plot(xeval,Loadings[,2]*sign(sum(Loadings[,2])),type="l", main=paste0("2nd PC (",round(100*FVE[2])," % of var)"))
  # plot(xeval, X[1,]+mu,type="l", ylim=range(X+mu))
  # for(n in 1:dim(X)[1]) points(xeval, X[n,]+mu,type="l")
  # points(xeval,mu,col=2,lwd=2,type="l")
  # points(xeval,mu+10*SVD$d[2]/lam*SVD$v[,2],col=2,lwd=2,type="l",lty=2)
  # points(xeval,mu-10*SVD$d[2]/lam*SVD$v[,2],col=2,lwd=2,type="l",lty=2)
  
  plot(xeval,Loadings[,3]*sign(sum(Loadings[,3])),type="l", main=paste0("3rd PC (",round(100*FVE[3])," % of var)"))
  # plot(xeval, X[1,]+mu,type="l", ylim=range(X+mu))
  # for(n in 1:dim(X)[1]) points(xeval, X[n,]+mu,type="l")
  # points(xeval,mu,col=2,lwd=2,type="l")
  # points(xeval,mu+30*SVD$d[3]/lam*SVD$v[,3],col=2,lwd=2,type="l",lty=2)
  # points(xeval,mu-30*SVD$d[3]/lam*SVD$v[,3],col=2,lwd=2,type="l",lty=2)
  
  plot(xeval,Loadings[,4]*sign(sum(Loadings[,4])),type="l", main=paste0("4th PC (",round(100*FVE[4])," % of var)"))
  # plot(xeval, X[1,]+mu,type="l", ylim=range(X+mu))
  # for(n in 1:dim(X)[1]) points(xeval, X[n,]+mu,type="l")
  # points(xeval,mu,col=2,lwd=2,type="l")
  # points(xeval,mu+30*SVD$d[4]/lam*SVD$v[,4],col=2,lwd=2,type="l",lty=2)
  # points(xeval,mu-30*SVD$d[4]/lam*SVD$v[,4],col=2,lwd=2,type="l",lty=2)
  return(SVD)
}
SVD = perform_pca(PCA_data) # t() so that individuals are rows
# perform_pca(t(mal_height))


```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R co




```{r}
library(readr)
X1976_2020_president <- read_csv("1976-2020-president.csv")
data_2020 = X1976_2020_president[which(X1976_2020_president$year == 2020),]
democratic_support = data_2020[which(data_2020$party_detailed == 'DEMOCRAT'),]
democratic_support$percentage = democratic_support$candidatevotes/democratic_support$totalvotes
democratic_data = cbind()

```

